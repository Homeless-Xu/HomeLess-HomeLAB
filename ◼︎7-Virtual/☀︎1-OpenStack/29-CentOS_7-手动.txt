â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸------â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸
ğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µ  GCE - CentOS_7 æ‰‹åŠ¨å®‰è£… -  ?  ğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µğŸ”µ
â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸------â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸â¬›ï¸

OpenStack æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå¯ä»¥éƒ¨ç½²åˆ°è‹¥å¹²èŠ‚ç‚¹ä¸Šï¼Œ 
æœ‰ä¸¤ç±»èŠ‚ç‚¹ï¼šè®¡ç®—èŠ‚ç‚¹å’Œæ§åˆ¶èŠ‚ç‚¹. æ§åˆ¶èŠ‚ç‚¹å¯ä»¥å½“æˆè®¡ç®—èŠ‚ç‚¹. 
ä¹Ÿå°±æ˜¯è¯´ æ§åˆ¶èŠ‚ç‚¹å…¶å® å…¶å®å¯ä»¥æ˜¯ä¸€ä¸ª All-in-One çš„æµ‹è¯•ç¯å¢ƒ

openstack ç”±å¾ˆå¤šå­æœåŠ¡ç»„æˆ. 
æ§åˆ¶èŠ‚ç‚¹éœ€è¦å®‰è£… æ‰€æœ‰ openstack éœ€è¦çš„æœåŠ¡.
è®¡ç®—èŠ‚ç‚¹åªè¦å®‰è£…  nova-compute å­æœåŠ¡ 

devstack åªèƒ½å®‰è£…æ•´ä¸ª ä¸‹é¢æˆ‘ä»¬æ¥å®Œå…¨æ‰‹åŠ¨æ­å»º. è¿™æ ·æ‰èƒ½æ·±å…¥å­¦ä¹ ..

é¦–å…ˆï¼Œæˆ‘ä¸ªäººå»ºè®®æ–°æ‰‹ä¸è¦ä½¿ç”¨Devstackã€RDOä»¥åŠFuelç­‰è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·ï¼Œéƒ¨ç½²ä¸€éä¸çŸ¥å…¶æ‰€ç„¶ã€‚
å½“ç„¶ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²å·¥å…·å°±æ˜¯æ­å»ºä¸€ä¸ªç½‘é¡µå‡ºæ¥. ä½ å®Œå…¨ä¸çŸ¥é“æ€ä¹ˆç”¨!
æˆ‘å¼ºçƒˆæ¨èå‚è€ƒå®˜æ–¹æ‰‹åŠ¨æ–‡æ¡£ä¸€æ­¥ä¸€æ­¥æ­å»ºOpenStack
https://docs.openstack.org/newton/install-guide-ubuntu/



ğŸ”¸ Misc ?? 

ç¦ç”¨è‡ªåŠ¨ç½‘ç»œç®¡ç†å·¥å…·. ???
ç½‘ç»œæ–¹é¢å¼ºçƒˆå»ºè®®æ‰‹åŠ¨é…ç½®! 
æ‰€ä»¥éœ€è¦ç¦ç”¨


ğŸ”¸ å‡çº§ç³»ç»Ÿ
    apt-get update && apt-get upgrade -y && apt-get dist-upgrade








ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸  å®‰è£…RabbitMQå’ŒNTP ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸

ğŸ”¸ å®‰è£…RabbitMQ:   apt-get install -y rabbitmq-server
ğŸ”¸ å®‰è£…NTPæœåŠ¡:    apt-get install -y ntp


ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ å®‰è£… MySQL ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸


ğŸ”¸ å®‰è£…MySQLå¹¶ä¸ºrootç”¨æˆ·è®¾ç½®å¯†ç :
    apt-get install -y mysql-server python-mysqldb


ğŸ”¸ é…ç½®mysqlç›‘å¬æ‰€æœ‰ç½‘ç»œæ¥å£è¯·æ±‚:
    sed -i 's/127.0.0.1/0.0.0.0/g' /etc/mysql/my.cnf
    service mysql restart


ğŸ”¸ åˆ›å»ºæ•°æ®åº“

mysql -u root -p

#Keystone
CREATE DATABASE keystone;
GRANT ALL ON keystone.* TO 'keystoneUser'@'%' IDENTIFIED BY 'keystonePass';

#Glance
CREATE DATABASE glance;
GRANT ALL ON glance.* TO 'glanceUser'@'%' IDENTIFIED BY 'glancePass';

#Neutron
CREATE DATABASE neutron;
GRANT ALL ON neutron.* TO 'neutronUser'@'%' IDENTIFIED BY 'neutronPass';

#Nova
CREATE DATABASE nova;
GRANT ALL ON nova.* TO 'novaUser'@'%' IDENTIFIED BY 'novaPass';

#Cinder
CREATE DATABASE cinder;
GRANT ALL ON cinder.* TO 'cinderUser'@'%' IDENTIFIED BY 'cinderPass';

quit;








ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ é…ç½®Keystone ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸ğŸ”¸




2.6. é…ç½®Keystone

å®‰è£…keystoneè½¯ä»¶åŒ…:

apt-get install -y keystone
åœ¨/etc/keystone/keystone.confä¸­è®¾ç½®è¿æ¥åˆ°æ–°åˆ›å»ºçš„æ•°æ®åº“:

connection = mysql://keystoneUser:keystonePass@10.10.10.51/keystone
é‡å¯èº«ä»½è®¤è¯æœåŠ¡å¹¶åŒæ­¥æ•°æ®åº“:

service keystone restart
keystone-manage db_sync
ä½¿ç”¨gitä»“åº“ä¸­è„šæœ¬å¡«å……keystoneæ•°æ®åº“ï¼š è„šæœ¬æ–‡ä»¶å¤¹

#æ³¨æ„åœ¨æ‰§è¡Œè„šæœ¬å‰è¯·æŒ‰ä½ çš„ç½‘å¡é…ç½®ä¿®æ”¹HOST_IPå’ŒHOST_IP_EXT

wget https://raw.github.com/xidianpanpei/OpenStack-Havana-Install-Guide-CN-OVS_MutliNode/master/KeystoneScripts/keystone_basic.sh
wget https://raw.github.com/xidianpanpei/OpenStack-Havana-Install-Guide-CN-OVS_MutliNode/master/KeystoneScripts/keystone_endpoints_basic.sh

chmod +x keystone_basic.sh
chmod +x keystone_endpoints_basic.sh

./keystone_basic.sh
./keystone_endpoints_basic.sh
åˆ›å»ºä¸€ä¸ªç®€å•çš„å‡­æ®æ–‡ä»¶ï¼Œè¿™æ ·ç¨åå°±ä¸ä¼šå› ä¸ºè¾“å…¥è¿‡å¤šçš„ç¯å¢ƒå˜é‡è€Œæ„Ÿåˆ°åŒçƒ¦:

vi creds-admin

#Paste the following:
export OS_TENANT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=admin_pass
export OS_AUTH_URL="http://192.168.100.51:5000/v2.0/"

# Load it:
source creds-admin
é€šè¿‡å‘½ä»¤è¡Œåˆ—å‡ºKeystoneä¸­æ·»åŠ çš„ç”¨æˆ·:

keystone user-list
2.7. è®¾ç½®Glance

å®‰è£…Glance:

apt-get install -y glance
æŒ‰ä¸‹é¢æ›´æ–°/etc/glance/glance-api-paste.ini:

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
delay_auth_decision = true
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = service_pass
æŒ‰ä¸‹é¢æ›´æ–°/etc/glance/glance-registry-paste.ini:

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = glance
admin_password = service_pass
æŒ‰ä¸‹é¢æ›´æ–°/etc/glance/glance-api.conf:

sql_connection = mysql://glanceUser:glancePass@10.10.10.51/glance
å’Œ:

[paste_deploy]
flavor = keystone
æŒ‰ä¸‹é¢æ›´æ–°/etc/glance/glance-registry.conf:

sql_connection = mysql://glanceUser:glancePass@10.10.10.51/glance
å’Œ:

[paste_deploy]
flavor = keystone
é‡å¯glance-apiå’Œglance-registryæœåŠ¡:

service glance-api restart; service glance-registry restart
åŒæ­¥glanceæ•°æ®åº“:

glance-manage db_sync
é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ:

service glance-registry restart; service glance-api restart
æµ‹è¯•Glance, ä»ç½‘ç»œä¸Šä¼ cirrosäº‘é•œåƒ:

glance image-create --name cirros --is-public true --container-format bare --disk-format qcow2 --location https://launchpad.net/cirros/trunk/0.3.0/+download/cirros-0.3.0-x86_64-disk.img

æ³¨æ„ï¼šé€šè¿‡æ­¤é•œåƒåˆ›å»ºçš„è™šæ‹Ÿæœºå¯é€šè¿‡ç”¨æˆ·å/å¯†ç ç™»é™†ï¼Œ ç”¨æˆ·åï¼šcirros å¯†ç ï¼šcubswin:)
æœ¬åœ°åˆ›å»ºUbuntuäº‘é•œåƒ:

wget http://cloud-images.ubuntu.com/precise/current/precise-server-cloudimg-amd64-disk1.img
glance add name="Ubuntu 12.04 cloudimg amd64" is_public=true container_format=ovf disk_format=qcow2 < ./precise-server-cloudimg-amd64-disk1.img
åˆ—å‡ºé•œåƒæ£€æŸ¥æ˜¯å¦ä¸Šä¼ æˆåŠŸ:

glance image-list
2.8. è®¾ç½®Neutron

å®‰è£…Neutronç»„ä»¶:

apt-get install -y neutron-server
ç¼–è¾‘/etc/neutron/api-paste.ini

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
ç¼–è¾‘OVSé…ç½®æ–‡ä»¶/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini:

#Under the database section
[DATABASE]
connection = mysql://neutronUser:neutronPass@10.10.10.51/neutron

#Under the OVS section
[OVS]
tenant_network_type = gre
tunnel_id_ranges = 1:1000
enable_tunneling = True

#Firewall driver for realizing neutron security group function
[SECURITYGROUP]
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
ç¼–è¾‘/etc/neutron/neutron.conf:

[keystone_authtoken]
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
signing_dir = /var/lib/neutron/keystone-signing
é‡å¯neutronæ‰€æœ‰æœåŠ¡:

cd /etc/init.d/; for i in $( ls neutron-* ); do sudo service $i restart; done
2.9. è®¾ç½®Nova

å®‰è£…novaç»„ä»¶:

apt-get install -y nova-api nova-cert novnc nova-consoleauth nova-scheduler nova-novncproxy nova-doc nova-conductor
åœ¨/etc/nova/api-paste.inié…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹è®¤è¯ä¿¡æ¯:

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = nova
admin_password = service_pass
signing_dirname = /tmp/keystone-signing-nova
# Workaround for https://bugs.launchpad.net/nova/+bug/1154809
auth_version = v2.0
å¦‚ä¸‹ä¿®æ”¹/etc/nova/nova.conf:

[DEFAULT]
logdir=/var/log/nova
state_path=/var/lib/nova
lock_path=/run/lock/nova
verbose=True
api_paste_config=/etc/nova/api-paste.ini
compute_scheduler_driver=nova.scheduler.simple.SimpleScheduler
rabbit_host=10.10.10.51
nova_url=http://10.10.10.51:8774/v1.1/
sql_connection=mysql://novaUser:novaPass@10.10.10.51/nova
root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf

# Auth
use_deprecated_auth=false
auth_strategy=keystone

# Imaging service
glance_api_servers=10.10.10.51:9292
image_service=nova.image.glance.GlanceImageService

# Vnc configuration
novnc_enabled=true
novncproxy_base_url=http://192.168.100.51:6080/vnc_auto.html
novncproxy_port=6080
vncserver_proxyclient_address=10.10.10.51
vncserver_listen=0.0.0.0

# Network settings
network_api_class=nova.network.neutronv2.api.API
neutron_url=http://10.10.10.51:9696
neutron_auth_strategy=keystone
neutron_admin_tenant_name=service
neutron_admin_username=neutron
neutron_admin_password=service_pass
neutron_admin_auth_url=http://10.10.10.51:35357/v2.0
libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver
linuxnet_interface_driver=nova.network.linux_net.LinuxOVSInterfaceDriver
#If you want Neutron + Nova Security groups
#firewall_driver=nova.virt.firewall.NoopFirewallDriver
#security_group_api=neutron
#If you want Nova Security groups only, comment the two lines above and uncomment line -1-.
firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver

#Metadata
service_neutron_metadata_proxy = True
neutron_metadata_proxy_shared_secret = helloOpenStack

# Compute #
compute_driver=libvirt.LibvirtDriver

# Cinder #
volume_api_class=nova.volume.cinder.API
osapi_volume_listen_port=5900
åŒæ­¥æ•°æ®åº“:

nova-manage db sync
é‡å¯æ‰€æœ‰novaæœåŠ¡:

cd /etc/init.d/; for i in $( ls nova-* ); do sudo service $i restart; done
æ£€æŸ¥æ‰€æœ‰novaæœåŠ¡æ˜¯å¦å¯åŠ¨æ­£å¸¸:

nova-manage service list
2.10. è®¾ç½®Cinder

å®‰è£…è½¯ä»¶åŒ…:

apt-get install -y cinder-api cinder-scheduler cinder-volume iscsitarget open-iscsi iscsitarget-dkms
é…ç½®iscsiæœåŠ¡:

sed -i 's/false/true/g' /etc/default/iscsitarget
é‡å¯æœåŠ¡:

service iscsitarget start
service open-iscsi start
å¦‚ä¸‹é…ç½®/etc/cinder/api-paste.ini:

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
service_protocol = http
service_host = 192.168.100.51
service_port = 5000
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = cinder
admin_password = service_pass
ç¼–è¾‘/etc/cinder/cinder.conf:

[DEFAULT]
rootwrap_config=/etc/cinder/rootwrap.conf
sql_connection = mysql://cinderUser:cinderPass@10.10.10.51/cinder
api_paste_config = /etc/cinder/api-paste.ini
iscsi_helper=ietadm
volume_name_template = volume-%s
volume_group = cinder-volumes
verbose = True
auth_strategy = keystone
#osapi_volume_listen_port=5900
æ¥ä¸‹æ¥åŒæ­¥æ•°æ®åº“:

cinder-manage db sync
æœ€ååˆ«å¿˜äº†åˆ›å»ºä¸€ä¸ªå·ç»„å‘½åä¸ºcinder-volumes:

dd if=/dev/zero of=cinder-volumes bs=1 count=0 seek=2G
losetup /dev/loop2 cinder-volumes
fdisk /dev/loop2
#Type in the followings:
n
p
1
ENTER
ENTER
t
8e
w
åˆ›å»ºç‰©ç†å·å’Œå·ç»„:

pvcreate /dev/loop2
vgcreate cinder-volumes /dev/loop2
æ³¨æ„: é‡å¯åå·ç»„ä¸ä¼šè‡ªåŠ¨æŒ‚è½½ (ç‚¹å‡»`è¿™ä¸ª <https://github.com/mseknibilel/OpenStack-Folsom-Install-guide/blob/master/Tricks%26Ideas/load_volume_group_after_system_reboot.rst>`_ è®¾ç½®åœ¨é‡å¯åè‡ªåŠ¨æŒ‚è½½)

é‡å¯cinderæœåŠ¡:

cd /etc/init.d/; for i in $( ls cinder-* ); do sudo service $i restart; done
ç¡®è®¤cinderæœåŠ¡åœ¨è¿è¡Œ:

cd /etc/init.d/; for i in $( ls cinder-* ); do sudo service $i status; done
2.11. è®¾ç½®Horizon

å¦‚ä¸‹å®‰è£…horizon

apt-get install -y openstack-dashboard memcached
å¦‚æœä½ ä¸å–œæ¬¢OpenStack ubuntuä¸»é¢˜, ä½ å¯ä»¥åœç”¨å®ƒ:

dpkg --purge openstack-dashboard-ubuntu-theme
é‡å¯Apacheå’ŒmemcachedæœåŠ¡:

service apache2 restart; service memcached restart
3. ç½‘ç»œèŠ‚ç‚¹

3.1. å‡†å¤‡èŠ‚ç‚¹

å®‰è£…å¥½Ubuntu 12.04 Server 64bitså, è¿›å…¥sudoæ¨¡å¼ç›´åˆ°å®Œæˆæœ¬æŒ‡å—:

sudo su -
æ·»åŠ Havanaä»“åº“:

apt-get install ubuntu-cloud-keyring python-software-properties software-properties-common python-keyring
echo deb http://ubuntu-cloud.archive.canonical.com/ubuntu precise-proposed/havana main >> /etc/apt/sources.list.d/havana.list
å‡çº§ç³»ç»Ÿ:

apt-get update
apt-get upgrade
apt-get dist-upgrade
å®‰è£…ntpæœåŠ¡:

apt-get install -y ntp
é…ç½®ntpæœåŠ¡ä»æ§åˆ¶èŠ‚ç‚¹åŒæ­¥æ—¶é—´:

#Comment the ubuntu NTP servers
sed -i 's/server 0.ubuntu.pool.ntp.org/#server 0.ubuntu.pool.ntp.org/g' /etc/ntp.conf
sed -i 's/server 1.ubuntu.pool.ntp.org/#server 1.ubuntu.pool.ntp.org/g' /etc/ntp.conf
sed -i 's/server 2.ubuntu.pool.ntp.org/#server 2.ubuntu.pool.ntp.org/g' /etc/ntp.conf
sed -i 's/server 3.ubuntu.pool.ntp.org/#server 3.ubuntu.pool.ntp.org/g' /etc/ntp.conf

#Set the network node to follow up your conroller node
sed -i 's/server ntp.ubuntu.com/server 10.10.10.51/g' /etc/ntp.conf

service ntp restart
3.2. é…ç½®ç½‘ç»œ

3å—ç½‘å¡å¦‚ä¸‹è®¾ç½®:

# OpenStack management
auto eth0
iface eth0 inet static
address 10.10.10.52
netmask 255.255.255.0

# VM internet Access
auto eth1
iface eth1 inet static
address 192.168.100.52
netmask 255.255.255.0
å¼€å¯è·¯ç”±è½¬å‘:

sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sysctl -p
3.3. OpenVSwitch

å®‰è£…OpenVSwitchè½¯ä»¶åŒ…:

apt-get install -y openvswitch-controller openvswitch-switch openvswitch-datapath-dkms
é‡æ–°å¯åŠ¨openvswitch-switch:

/etc/init.d/openvswitch-switch restart
æ·»åŠ ç½‘æ¡¥ br-ex å¹¶æŠŠç½‘å¡ eth1 åŠ å…¥ br-ex:

ovs-vsctl  add-br br-ex
ovs-vsctl add-port br-ex eth1
å¦‚ä¸‹ç¼–è¾‘/etc/network/interfaces:

# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# Not internet connected(used for OpenStack management)
# The primary network interface
auto eth0
iface eth0 inet static
# This is an autoconfigured IPv6 interface
# iface eth0 inet6 auto
address 10.10.10.52
netmask 255.255.255.0

#For Exposing OpenStack API over the internet
auto eth1
iface eth1 inet manual
up ifconfig $IFACE 0.0.0.0 up
up ip link set $IFACE promisc on
down ip link set $IFACE promisc off
down ifconfig $IFACE down

auto br-ex
iface br-ex inet static
address 192.168.100.52
netmask 255.255.255.0
gateway 192.168.100.1
dns-nameservers 8.8.8.8
é‡å¯ç½‘ç»œæœåŠ¡:

/etc/init.d/networking restart
åˆ›å»ºå†…ç½‘ç½‘æ¡¥br-int:

ovs-vsctl add-br br-int
æŸ¥çœ‹ç½‘æ¡¥é…ç½®:

root@openstack-network:~# ovs-vsctl list-br
br-ex
br-int

root@openstack-network:~# ovs-vsctl show
ebea0b50-e450-41ea-babb-a094ca8d69fa
    Bridge br-int
        Port br-int
            Interface br-int
                type: internal
    Bridge br-ex
        Port "eth1"
            Interface "eth1"
        Port br-ex
            Interface br-ex
                type: internal
    ovs_version: "1.4.0+build0"
3.4. Neutron-*

å®‰è£…Neutronç»„ä»¶:

apt-get -y install neutron-plugin-openvswitch-agent neutron-dhcp-agent neutron-l3-agent neutron-metadata-agent
ç¼–è¾‘/etc/neutron/api-paste.ini

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
ç¼–è¾‘OVSé…ç½®æ–‡ä»¶/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini:

#Under the database section
[DATABASE]
connection = mysql://neutronUser:neutronPass@10.10.10.51/neutron

#Under the OVS section
[OVS]
tenant_network_type = gre
enable_tunneling = True
tunnel_id_ranges = 1:1000
integration_bridge = br-int
tunnel_bridge = br-tun
local_ip = 10.10.10.52

#Firewall driver for realizing neutron security group function
[SECURITYGROUP]
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
æ›´æ–°/etc/neutron/metadata_agent.ini:

# The Neutron user information for accessing the Neutron API.
auth_url = http://10.10.10.51:35357/v2.0
auth_region = RegionOne
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass

# IP address used by Nova metadata server
nova_metadata_ip = 10.10.10.51

# TCP Port used by Nova metadata server
nova_metadata_port = 8775

metadata_proxy_shared_secret = helloOpenStack
ç¼–è¾‘/etc/neutron/neutron.conf:

# ç¡®ä¿RabbitMQ IPæŒ‡å‘äº†æ§åˆ¶èŠ‚ç‚¹
rabbit_host = 10.10.10.51

[keystone_authtoken]
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
signing_dir = /var/lib/neutron/keystone-signing

[DATABASE]
connection = mysql://neutronUser:neutronPass@10.10.10.51/neutron
ç¼–è¾‘/etc/neutron/l3_agent.ini:

[DEFAULT]
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
use_namespaces = True
external_network_bridge = br-ex
signing_dir = /var/cache/neutron
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
auth_url = http://10.10.10.51:35357/v2.0
l3_agent_manager = neutron.agent.l3_agent.L3NATAgentWithStateReport
root_helper = sudo neutron-rootwrap /etc/neutron/rootwrap.conf
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
ç¼–è¾‘/etc/neutron/dhcp_agent.ini:

[DEFAULT]
interface_driver = neutron.agent.linux.interface.OVSInterfaceDriver
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
use_namespaces = True
signing_dir = /var/cache/neutron
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
auth_url = http://10.10.10.51:35357/v2.0
dhcp_agent_manager = neutron.agent.dhcp_agent.DhcpAgentWithStateReport
root_helper = sudo neutron-rootwrap /etc/neutron/rootwrap.conf
state_path = /var/lib/neutron
é‡å¯neutronæ‰€æœ‰æœåŠ¡:

cd /etc/init.d/; for i in $( ls neutron-* ); do sudo service $i restart; done
4. è®¡ç®—èŠ‚ç‚¹

4.1. å‡†å¤‡èŠ‚ç‚¹

å®‰è£…å¥½Ubuntu 12.04 Server 64bitså,å‡çº§ç³»ç»Ÿå¹¶é‡å¯ä¹‹å,è¿›å…¥sudoæ¨¡å¼ç›´åˆ°å®Œæˆæœ¬æŒ‡å—:

sudo su -
æ·»åŠ Havanaä»“åº“:

apt-get install ubuntu-cloud-keyring python-software-properties software-properties-common python-keyring
echo deb http://ubuntu-cloud.archive.canonical.com/ubuntu precise-proposed/havana main >> /etc/apt/sources.list.d/havana.list
å‡çº§ç³»ç»Ÿ:

apt-get update
apt-get upgrade
apt-get dist-upgrade
å®‰è£…ntpæœåŠ¡:

apt-get install -y ntp
é…ç½®ntpæœåŠ¡ä»æ§åˆ¶èŠ‚ç‚¹åŒæ­¥æ—¶é—´:

#Comment the ubuntu NTP servers
sed -i 's/server 0.ubuntu.pool.ntp.org/#server 0.ubuntu.pool.ntp.org/g' /etc/ntp.conf
sed -i 's/server 1.ubuntu.pool.ntp.org/#server 1.ubuntu.pool.ntp.org/g' /etc/ntp.conf
sed -i 's/server 2.ubuntu.pool.ntp.org/#server 2.ubuntu.pool.ntp.org/g' /etc/ntp.conf
sed -i 's/server 3.ubuntu.pool.ntp.org/#server 3.ubuntu.pool.ntp.org/g' /etc/ntp.conf

#Set the network node to follow up your conroller node
sed -i 's/server ntp.ubuntu.com/server 10.10.10.51/g' /etc/ntp.conf

service ntp restart
4.2. é…ç½®ç½‘ç»œ

å¦‚ä¸‹é…ç½®ç½‘ç»œ:

# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

# The loopback network interface
auto lo
iface lo inet loopback

# Not internet connected(used for OpenStack management)
# The primary network interface
auto eth0
iface eth0 inet static
address 10.10.10.53
netmask 255.255.255.0
gateway 10.10.10.1

# VM Configuration
auto eth1
iface eth1 inet static
address 192.168.100.53
netmask 255.255.255.0
gateway 192.168.100.1
å¼€å¯è·¯ç”±è½¬å‘:

sed -i 's/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/' /etc/sysctl.conf
sysctl -p
4.3. KVM

ç¡®ä¿ä½ çš„ç¡¬ä»¶å¯ç”¨virtualization:

apt-get install cpu-checker
kvm-ok
ç°åœ¨å®‰è£…kvmå¹¶é…ç½®å®ƒ:

apt-get install -y kvm libvirt-bin pm-utils
åœ¨/etc/libvirt/qemu.confé…ç½®æ–‡ä»¶ä¸­å¯ç”¨cgroup_device_aclæ•°ç»„:

cgroup_device_acl = [
"/dev/null", "/dev/full", "/dev/zero",
"/dev/random", "/dev/urandom",
"/dev/ptmx", "/dev/kvm", "/dev/kqemu",
"/dev/rtc", "/dev/hpet","/dev/net/tun"
]
åˆ é™¤é»˜è®¤çš„è™šæ‹Ÿç½‘æ¡¥:

virsh net-destroy default
virsh net-undefine default
æ›´æ–°/etc/libvirt/libvirtd.confé…ç½®æ–‡ä»¶:

listen_tls = 0
listen_tcp = 1
auth_tcp = "none"
Eç¼–è¾‘libvirtd_optså˜é‡åœ¨/etc/init/libvirt-bin.confé…ç½®æ–‡ä»¶ä¸­:

env libvirtd_opts="-d -l"
ç¼–è¾‘/etc/default/libvirt-binæ–‡ä»¶

libvirtd_opts="-d -l"
é‡å¯libvirtæœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ:

service libvirt-bin restart
4.4. OpenVSwitch

å®‰è£…OpenVSwitchè½¯ä»¶åŒ…:

apt-get install -y openvswitch-controller openvswitch-switch openvswitch-datapath-dkms
é‡å¯openvswitch-switch:

/etc/init.d/openvswitch-switch restart
åˆ›å»ºç½‘æ¡¥:

#br-int will be used for VM integration
ovs-vsctl add-br br-int
4.5. Neutron

å®‰è£…Neutron openvswitchä»£ç†:

apt-get -y install neutron-plugin-openvswitch-agent
ç¼–è¾‘OVSé…ç½®æ–‡ä»¶/etc/neutron/plugins/openvswitch/ovs_neutron_plugin.ini:

#Under the database section
[DATABASE]
connection = mysql://neutronUser:neutronPass@10.10.10.51/neutron

#Under the OVS section
[OVS]
tenant_network_type = gre
tunnel_id_ranges = 1:1000
integration_bridge = br-int
tunnel_bridge = br-tun
local_ip = 10.10.10.53
enable_tunneling = True

#Firewall driver for realizing neutron security group function
[SECURITYGROUP]
firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver
ç¼–è¾‘/etc/neutron/neutron.conf:

# ç¡®ä¿RabbitMQ IPæŒ‡å‘äº†æ§åˆ¶èŠ‚ç‚¹
rabbit_host = 10.10.10.51

[keystone_authtoken]
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = neutron
admin_password = service_pass
signing_dir = /var/lib/neutron/keystone-signing

[DATABASE]
connection = mysql://neutronUser:neutronPass@10.10.10.51/neutron
é‡å¯neutron openvswitchä»£ç†æœåŠ¡:

service neutron-plugin-openvswitch-agent restart
4.6. Nova

å®‰è£…novaç»„ä»¶:

apt-get install -y nova-compute-kvm

æ³¨æ„ï¼šå¦‚æœä½ çš„å®¿ä¸»æœºä¸æ”¯æŒkvmè™šæ‹ŸåŒ–ï¼Œå¯æŠŠnova-compute-kvmæ¢æˆnova-compute-qemu
åŒæ—¶/etc/nova/nova-compute.confé…ç½®æ–‡ä»¶ä¸­çš„libvirt_type=qemu
åœ¨/etc/nova/api-paste.inié…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹è®¤è¯ä¿¡æ¯:

[filter:authtoken]
paste.filter_factory = keystoneclient.middleware.auth_token:filter_factory
auth_host = 10.10.10.51
auth_port = 35357
auth_protocol = http
admin_tenant_name = service
admin_user = nova
admin_password = service_pass
signing_dirname = /tmp/keystone-signing-nova
# Workaround for https://bugs.launchpad.net/nova/+bug/1154809
auth_version = v2.0
å¦‚ä¸‹ä¿®æ”¹/etc/nova/nova.conf:

[DEFAULT]
logdir=/var/log/nova
state_path=/var/lib/nova
lock_path=/run/lock/nova
verbose=True
api_paste_config=/etc/nova/api-paste.ini
compute_scheduler_driver=nova.scheduler.simple.SimpleScheduler
rabbit_host=10.10.10.51
nova_url=http://10.10.10.51:8774/v1.1/
sql_connection=mysql://novaUser:novaPass@10.10.10.51/nova
root_helper=sudo nova-rootwrap /etc/nova/rootwrap.conf

# Auth
use_deprecated_auth=false
auth_strategy=keystone

# Imaging service
glance_api_servers=10.10.10.51:9292
image_service=nova.image.glance.GlanceImageService

# Vnc configuration
novnc_enabled=true
novncproxy_base_url=http://192.168.100.51:6080/vnc_auto.html
novncproxy_port=6080
vncserver_proxyclient_address=10.10.10.53
vncserver_listen=0.0.0.0

# Network settings
network_api_class=nova.network.neutronv2.api.API
neutron_url=http://10.10.10.51:9696
neutron_auth_strategy=keystone
neutron_admin_tenant_name=service
neutron_admin_username=neutron
neutron_admin_password=service_pass
neutron_admin_auth_url=http://10.10.10.51:35357/v2.0
libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver
linuxnet_interface_driver=nova.network.linux_net.LinuxOVSInterfaceDriver
#If you want Neutron + Nova Security groups
#firewall_driver=nova.virt.firewall.NoopFirewallDriver
#security_group_api=neutron
#If you want Nova Security groups only, comment the two lines above and uncomment line -1-.
firewall_driver=nova.virt.libvirt.firewall.IptablesFirewallDriver

#Metadata
service_neutron_metadata_proxy = True
neutron_metadata_proxy_shared_secret = helloOpenStack

# Compute #
compute_driver=libvirt.LibvirtDriver

# Cinder #
volume_api_class=nova.volume.cinder.API
osapi_volume_listen_port=5900
cinder_catalog_info=volume:cinder:internalURL
ä¿®æ”¹/etc/nova/nova-compute.conf:

[DEFAULT]
libvirt_type=kvm
compute_driver=libvirt.LibvirtDriver
libvirt_ovs_bridge=br-int
libvirt_vif_type=ethernet
libvirt_vif_driver=nova.virt.libvirt.vif.LibvirtHybridOVSBridgeDriver
libvirt_use_virtio_for_bridges=True
é‡å¯æ‰€æœ‰novaæœåŠ¡:

cd /etc/init.d/; for i in $( ls nova-* ); do sudo service $i restart; done
æ£€æŸ¥æ‰€æœ‰novaæœåŠ¡æ˜¯å¦å¯åŠ¨æ­£å¸¸:

nova-manage service list
5. ç»“æŸè¯­

ç”±äºé¡¹ç›®ç»„éœ€æ±‚è¦æ±‚ï¼Œè¯¥æ­å»ºæ•™ç¨‹ä¸­æ²¡æœ‰æ­å»ºHavanaç‰ˆæœ¬ä¸­æ–°æ·»åŠ çš„Ceilmeterå’ŒHeatç»„ä»¶ã€‚

é€šè¿‡å¯¹Havanaç‰ˆæœ¬çš„æ­å»ºå¯ä»¥çœ‹åˆ°ï¼ŒHavanaç‰ˆæœ¬çš„æ•´ä¸ªæ­å»ºè¿‡ç¨‹ç›¸æ¯”äºGrizzlyç‰ˆæœ¬æ¥è¯´ï¼Œå¹¶æ²¡æœ‰å‘ç”Ÿå¾ˆæ˜æ˜¾çš„å˜åŒ–ï¼Œä¸»è¦æ˜¯æœ‰äº›å‚æ•°é…ç½®æ‰€åœ¨æ–‡ä»¶æœ‰æ‰€å˜æ›´ã€‚åŒæ—¶ï¼Œé’ˆå¯¹ä½¿ç”¨OpenvSwitchæ’ä»¶ï¼Œå…¶ä¸­åŸæ¥ä¸­æ–‡ç‰ˆä¸­çš„openvswitch-brcompatå·²ç»æ— æ³•åŒ¹é…Havanaç‰ˆæœ¬ï¼Œå› æ­¤æ­¤éƒ¨åˆ†æ•™ç¨‹å‚ç…§äº†è‹±æ–‡ç‰ˆæ•™ç¨‹æ›´æ”¹è€Œæ¥ã€‚

ps:åœ¨æ­å»ºè¿‡ç¨‹ä¸­ç»†å¿ƒçœŸçš„æ˜¯éå¸¸é‡è¦çš„ï¼Œå¦åˆ™ï¼Œç»å¸¸ä¼šå› ä¸ºæŸä¸ªé…ç½®é”™è¯¯ï¼Œå¯¼è‡´èŠ±è´¹å¤§é‡æ—¶é—´æŸ¥é”™


