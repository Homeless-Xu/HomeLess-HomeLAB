@: ❤️路由❤️


这些设备的基本原理类似.

交换机: 局域网内部转发数据.
路由器: 互联网上面选择最优路径 + 转发数据.




## 简介

交换机、路由器、网络协议 是网管最最基本的知识.必须了解.
理解了这些 很多网络问题 就可以迅速定位问题源头!!!


路由器 工作在 OSI模型的第三层 → 网络层.

工作原理和交换机差不多. 路由器内部也有一个表.
这个表会指导数据包 如果要去某个地方.  下一步应该向哪里走.
如果路由表 不知道下一步往哪里走 那就丢弃那个数据包.







互联网上数据包从一台电脑 到另外一条电脑 是要经过很多路由器的!!!
路由器会自动帮你选择一跳最合适的路径.(路径不是唯一的!!!)

**每经过一个路由器的转发就称为一跳; 每一跳 TTL值 -1; TTL值变0 路由器就会丢弃该数据包.**


> TTL
> 
> 为什么要有TTL这个东西呢. 数据包就像汽车. 光纤就像高速公路. 车多了公路是会堵的. 
> 数据包有很多是无用的.这些没人要的 或者有人故意不要的数据包就会变成垃圾.
> 如果数据包永远都不会死.那么公路上就会出现越来越多的汽车. 导致全世界的网络都瘫痪.


> ICMP
> 
> 网络控制消息携带.
> 网络协议的 核心协议之一.
> 
> 提供可能发送在网络通信中的各种反馈.
> 通过这些信息.网管才能对出现的问题作出诊断.并采取措施.
> 
> 最常见的ICMP错误消息 就是 TTL值过期.
> 每个路由器在转发数据时
> 都会把IP包头中的 TTL值 减去1.
> 一旦TTL值变为0.  那么这个数据包就会被扔掉. 同时返回一个ICMP TTL在传输过程中过期的消息给源地址.
> 
> 
> 还有个作用 就是有些主机发出的数据包太大 而且不允许拆分.
> 这时候ICMP 就会告诉那个主机 你的数据包太大了.分小一点再发送!!




## 单播 多播 广播
单播: Unicast
多播: Multicast
广播: Broadcast

这三个都是 网络节点之间的通讯方式. 有什么区别呢.

### 广播:
一个局域网内.
如果一台电脑想 通过某个IP地址对应的MAC地址.
那就得给 所有的局域网内的电脑都发一个消息:
是这个IP地址的 给我把你的MAC地址 回复给我


给所有人都发消息的  就叫广播.


客户机 通过DHCP 自动获取IP的过程就是 通过广播来实现的.

广播会占用子网内的 所有带宽!!!
就好象.操场内 只有一个人可以使用扩音器.
如果很多人都使用扩音器 那就整个操场就乱套了. 谁都不能正常交流了.

IP网络中 使用 255.255.255.255 来表示一个子网内的 所有IP地址.












### 单播
网络节点之间的通信 就像人类交流.
我和你单独说话 就是单播放.
单播 也叫 点对点通信 是用的最多的.




### 多播
视频会议就是多播. 把一个数据 发送给多个接收地址..
























常见的路由器 后面5个口. 1个单独的口. 4个并排的口.
单独的口 是网络进入口. 一般是外网. 也可以是内网.
其他4个口. 就相对于一个交换机了!!!!
所以 路由器也可以当交换机用. 
但是路由器和交换机 各有各的优缺点.
路由器主要功能 就是路由. 也就是给数据包 指路:
如果你这个数据包想要到底目的地. 那就要路由器告诉你怎么走.



路由器 其实是一个 逻辑概念.
常见的路由器 和 企业的路由器完全是两个东西.
企业的路由器.. 好像是42u的. 大概有4个PC主机箱的大小.
上面的接口 那是多的不得了...
我们拿 企业路由器来说明

企业么. 会分成好几个局域网:
多个局域网的好处这里就不说了.
最常见的就是 广播风暴. 
如果你公司所有人都在一个局域网. 只要有人拿网线给你弄个回路.
整个公司都不能上网了. 这时候你网管的压力 可想而知了.
但是这个问题不是那么好排查的.所以 不管网络瘫痪多久. 必然会很大的影响.

如果分成好几个局域网 那就可以大致判断 哪个区域出问题了.
至少能给你问题排查 缩小到很小一块区域.
这个局域网的网络风暴 也不会影响到别的局域网. 造成的影响不会很大.


顺便说下VLAN. 
支持Vlan的交换机.  一个交换机可以分成好几个 局域网.
不支持VLAN的交换机. 一个交换机只能当作一个局域网.
企业 一般用 支持VLAN的交换机多点. 方便管理.



所以这里就分成 LAN1, LAN2. LAN3,
默认情况下. 不同的局域网之间是不能通信的.
你要这三个局域网能互相通信:  每个局域网都得有一根网线连到 核心路由器上.
然后路由器上 手动设置下路由. 就可以实现 不同的vlan 相互通信了.



路由器有多个接口.用于连接各种 局域网 . 以及多种链路(外网).
使得他们可以互相通信(局域网和局域网通信. 局域网和外网通信)


**路由器的核心是 一张路由表.通过路由器的所有数据都要经过这张路由表来转发.**
**路由器的核心是 一张路由表.通过路由器的所有数据都要经过这张路由表来转发.**
**路由器的核心是 一张路由表.通过路由器的所有数据都要经过这张路由表来转发.**








## 路由器功能:
1. 控制层面: 形成和维护路由表.决定最优路由
2. 转发层面: 根据路由表来实现数据转发.

由路由算法计算出到达目的地址的最佳路径.
然后由相对简单直接的转发机制 发送数据包.








## 路由工作原理
[https://drive.google.com/open?id=0B3zK8mnVu2IBaDNwbDlndXh3YUU]


**路由器是根据 路由表中的 网段 来匹配的.**
路由表中的每一行 代表一个路由.

1. 数据包进入路由器.
2. 查看数据包  目标IP, 算出该IP的网段
3. 查看路由表, 是否有刚才算出的网段.
4. 无匹配网段 → 代表无匹配路由: 丢弃该数据包.
5. 有匹配网段 → 代表有匹配路由: 进行转发.





## 路由表 FIB表

路由器 在接收到数据时. 要对其传输路径进行选择.
为了实现这个目标.路由器需要维护一个 称为 路由表的 表格.



路由 是数据通信网络中 最基本的要素.
路由信息 就是指导报文发送的路径信息.
路由的过程就是 报文转发的过程.



路由根据目的地不同 可分为:
1. 网段路由
目的地为网段. IPv4 地址 子网掩码长度 小于32位.


2. 主机路由

目的地为主机. IPv4 地址 子网掩码长度 等于32位.




根据 目的地与该路由器是否直接相连 路由又分为:
1. 直连路由:
目的地所在网络 与 路由器直接相连.
2. 间接路由:
目的地所在网络 与 路由器非直接相连.


根据目的地 地址类型的不同. 路由还可分为:
1. 单播路由:
表示将报文转发的目的地是一个单播地址.
2. 组播路由:
表示将报文转发的目的地是一个组播地址.








路由表: Routing table
路由择域信息库: Routing Information Base

路由器 使用 本地核心路由表 来保存决策优选路由.
并负责把优选路由下发到FIB表. 通过FIB表指导报文进行转发.
着张路由表 依据各种路由协议的优先级 和度量值来 选取路由.


每个路由器都至少有一张 路由表 和 一张FIB表
**路由器通过 路由表 来选择路由, 通过FIB表指导报文进行转发**
**路由器通过 路由表 来选择路由, 通过FIB表指导报文进行转发**
**路由器通过 路由表 来选择路由, 通过FIB表指导报文进行转发**



路由表是储存在RAM中的 一份数据文件:
含有 本地和周边网络的拓补信息(也就是路由).

路由表的作用是生成一个小型的 指向表(FIB表)


**路由来源**

- 方法一: 本地路由器接口
所谓的直连路由:只要路由器中的某个接口开启了(插上网线或者光纤了). 
那么这个接口所在的网段会自动进入全局路由表.

- 方法二: 手工配置
这种手工配置的叫静态路由:

- 方法三: 从其他路由器智能学习
通过动态路由协议学习到的








## 静态路由 与 动态路由
路由器 不仅支持 静态路由. 同时也支持RIP OSPF IS-IS BGP 等动态路由协议.


静态路由 和 动态路由区别:

路由协议 是路由器直接 维护路由表的规则.
用于发现路由.生成路由表.
并指导报文转发.
路由可以分为 三大类:
1. 通过链路层协议发现的 路由称为直连路由.
2. 通过网管手动配置的路由称为静态路由
3. 通过动态路由协议发现的路由称为 动态路由.


静态路由配置方便.对系统要求低.
适用于 拓补结构简单并且稳定的小网络.
缺点是不能自动适应网络拓补的变化. 需要人工干预.

动态路由协议有自己的路由算法.
能自动适应网络拓补的变化.
适用于具有一定数量三层设备的网络.
缺点是配置对用户要求比较高.
对系统要求高于静态路由.
并要占用一定的网络资源 和 系统资源.






## 动态路由:

路由信息: 包括远端网络信息 和 本地网络信息.
本地的网络结构是 保密的. 不然别人就知道你内网的拓补结构了!!!
所以只会共享 远端的网络信息.
你共享 我共享 ... 大家都有了....




路由协议允许 路由器共享远端网络信息. 也允许别的路由器共享出来的远端信息添加到自己的路由表中.









动态路由的分类:











对动态路由协议的分类可以采用以下不同标准：
根据作用范围不同，路由协议可分为：
1、内部网关协议IGP（Interior Gateway Protocol）：
在一个自治系统内部运行。常见的IGP协议包括RIP、OSPF和IS-IS。
2、外部网关协议EGP（Exterior Gateway Protocol）：
运行于不同自治系统之间。BGP是目前最常用的EGP协议。
 
根据使用算法不同，路由协议可分为：
1、距离矢量协议（Distance-Vector Protocol）：
包括RIP和BGP。其中，BGP也被称为路径矢量协议（Path-Vector Protocol）。
2、链路状态协议（Link-State Protocol）：
包括OSPF和IS-IS。
以上两种算法的主要区别在于发现路由和计算路由的方法不同。
 






### 路由协议 无须深入



根据功能不同. 
路由协议可以分为 
内部网关协议（IGP，Interior Gateway Protocol）
外部网关协议（EGP，Exterior Gateway Protocol）

内部网关协议 是用于 自治系统内部的动态路由协议: 如RIP OSPF
外部网关协议 是用于 自治系统之间拓补信息交换的路由协议: 如BGP


根据算法不同. 路由协议可以分为. 距离矢量路由协议. 和 链路状态路由协议.


路由器之间 是可以相互交换路由表的!!!
所以才能自动帮你选择最佳路径..
- RIP/RIP2 (Distance Vector)
	- OSPF     (Link Status)
	- ISIS     (Link Status)
	- BGP
	- EIGRP 
	
	
	
	Distance Vector 距离.
	- 按照跳数 来判断路由器之间的距离.
	- 把学到的路由. 跳数+1 传送给隔壁的路由器.



### 路由维护方式 (路由通过协议)

- 方式一:
将全部或者部分的路由信息公布出去.
这一类的路由协议称为 矢量路由协议.


- 方式二:
将自己的 链路状态信息进行广播. 
这类路由称为 链路状态路由协议.



不管哪种方式: 路由器都会通过互相学习,掌握全网的路由信息, 
由于路由器 需要做大量的 路径计算工作,CPU的工作能力直接决定了性能的好坏.














## 路由表实例 (路由器)

'' // 路由器中. 执行 display ip routing-table 来查看路由表概要信息.
'' 
'' D, 10.1.1.0/24,  [90/2170112], via, 209.165.200.226,  00:00:05, Serial0/0/0
'' 
'' 10.1.1.0/24      ❤️路由网段!! 注意是网段不是某个具体IP.❤️  
''                  只要是这个网段内的IP包.都发送到这个网段
'' 
''                  /32 /20 /4 是代表这个网段的子网掩码的长度.
''                  可以看成 255.255.255.0 这种形式的缩写.
'' 
'' 
'' 209.165.200.226  ❤️Next Hop❤️  下一条路由器的IP地址. 
''                  路由器直接发送数据包 也是要IP 和MAC地址.
''                  有了IP 就可以用ARP来获取 MAC地址
'' 
'' Serial/0/0/0     ❤️出接口: 转发端口❤️
''                  这个网段的数据 从路由器上的这个接口 转发出去!!!
'' 
'' 
'' D:               路径是怎样学习到的. 
'' 
'' 90               路由来源的可信度.(值越低 可信度越高,越优先选择)
'' 2170112          Metric.到达目的最佳路径的一种算法. 值越低 优先级越高,越优先选择
'' 00:00:05         自学习路径以来过了多少时间.
'' 
'' 
'' // 直连路由选项表:
'' C 192.168.10.0/24 is directly connected, GigabitEthernet0/0
'' L 192.168.10.1/32 is directly connected, GigabitEthernet0/0
'' 
'' C : 直连网段
'' L : 路由器接口地址
 













## 路由表 实例( MacOS )
Mac系统 也是有路由表的. 虽然和路由器的路由表有区别 但是可以参考.

每一行都是一条路由.
'' ➜  cms git:(master) ✗ netstat -r
'' Routing tables
'' 
'' Internet:
'' Destination        Gateway            Flags        Refs      Use   Netif Expire
'' default            101.92.192.1       UGSc          317        0     en0
'' // 表示 数据 默认是发送到 101.92.192.1 这个网关的.
'' 
'' 101.92.192/20      link#4             UCS             9        0     en0
'' 101.92.192.1/32    link#4             UCS             2        0     en0
'' 101.92.192.1       a0:f3:e4:97:b4:d1  UHLWIir       316        0     en0   1137
'' 101.92.194.59      link#4             UHLWIi          1        2     en0
'' 101.92.194.79      a0:f3:e4:97:b4:d1  UHLWIi          1        2     en0    876
'' 101.92.194.119     a0:f3:e4:97:b4:d1  UHLWIi          1        1     en0    256
'' 101.92.194.124     link#4             UHLWIi          1        3     en0
'' 101.92.194.128     link#4             UHLWIi          1        1     en0
'' 101.92.194.136/32  link#4             UCS             1        0     en0
'' 101.92.194.140     link#4             UHLWIi          1        9     en0
'' 101.92.194.214     link#4             UHLWIi          1        1     en0
'' 101.92.207.255     link#4             UHLWbI          1        9     en0
'' 127                localhost          UCS             3      369     lo0
'' localhost          localhost          UH             21  8717806     lo0
'' 127.0.0.2          localhost          UHWIi           1        6     lo0
'' 127.255.255.255    localhost          UHWIi           1        1     lo0
'' 224.0.0/4          link#4             UmCS            3        0     en0
'' 224.0.0.251        1:0:5e:0:0:fb      UHmLWI          1        0     en0
'' 239.255.255.250    1:0:5e:7f:ff:fa    UHmLWI          1      142     en0
'' 255.255.255.255/32 link#4             UCS             1        0     en0
'' 
'' Internet6:
'' Destination        Gateway            Flags         Netif Expire
'' default            fe80::%utun0       UGcI          utun0
'' localhost          localhost          UHL             lo0
'' fd42:b6ca:ab00:e5f fe80::29ce:aefa:ca Uc            utun1
'' fd42:b6ca:ab00:e5f link#11            UHL             lo0
'' fe80::%lo0         fe80::1%lo0        UcI             lo0
'' fe80::1%lo0        link#1             UHLI            lo0
'' fe80::%en0         link#4             UCI             en0
'' fe80::c22:7862:b56 3c:15:c2:d6:e:fa   UHLI            lo0
'' fe80::%awdl0       link#8             UCI           awdl0
'' fe80::10ab:e9ff:fe 12:ab:e9:a8:b7:cb  UHLI            lo0

































交换机工作数据链路层(第二层). 作用是在内网 转发以太网帧.

但是 当 源和目的IP地址位于不同网络时. 以太网帧必须发送给路由器.
路由器负责在不同的网络之间传输报文.

通过路由表来决定最佳转发路径.
当主机把报文发送到外网时. 
由于主机无法之间 与内网以外的设备通信.
报文将被发送至默认网关.
默认网关就是一个中转站. 
通常用来连接  内网 与 外网








IP 其实是分 网络部分 和 主机部分的.


我们这里说的是 宽带供应商的专业路由器.
专业的路由器是有很多的接口的.连有很多根光纤.每个光纤对应一个公网IP.
不像我们家用的路由器 后面只有一根光纤或网线.

这时候 一个数据包发到路由器. 路由器就必须决定从哪个光纤出去.
这就用到了 每个路由器内部都有的 一个 路由表

表格中 会有 哪个网段的IP 都通过哪个光纤出去.
注意表格中的是 网段 而不是某个IP.
因为全世界 那么多IP. 不可能把所有IP都写进这个表的.
就是写进去. 那么多数据你要查找这张表的某个数据 也是很困难的.

那么这张路由表是怎么来的呢.



## 路由过程详解




- 初始数据包:
来源MAC地址: 电脑的MAC地址
目标MAC地址: 目标的MAC地址 
来源IP 地址: 电脑的IP 地址
目的IP 地址: 目标的IP 地址



源主机发起通信前.
先通过子网掩码 . 把自己的IP地址 与 目的IP地址进行比较.
判断是否在一个网段.
如果不是一个网段 那就需要 网关 来帮它传递数据.给目的IP.
源主机 如果不知道网关的MAC地址. 会发一个 arp请求包 来获取网关的MAC地址.
我们这里 假设 目标IP 不在一个局域网内.



- 修改后的数据包:
来源MAC地址: 电脑的MAC地址
目标MAC地址: 网关的MAC地址 
来源IP 地址: 电脑的IP 地址
目的IP 地址: 目的的IP 地址


网关收到 修改后的数据包.
得知 源主机IP 和 目标IP 不在一个网段.
于是把数据 上传到 三层交换引擎(ASIC芯片).
在里面查看有无 目的主机的 三层转发表.



如果 三层交换机中的 转发表中含有 目标主机所在网段的路由表项目.
那么 还需要得到目标主机的MAC地址.
于是 三层交换机CPU向目标所在的网段发送一个arp请求包. 获得目标主机的MAC地址.

交换机获得目标的MAC地址后. 向ARP表中 添加对应的表项信息.
并转发由源主机到目标主机的 数据包.
同时 三层交换机 会结合路由表 生成目的主机的三层硬件转发表.

以后只要是 送到这个主机的数据包 就可以直接利用 三层硬件转发表 进行数据交换.
不用再去查看 cpu中的 路由表了.



如果 三层交换机的 转发表中没有找到 目标主机的对应信息.
那就向 CPU请求查看软件路由表.


































































